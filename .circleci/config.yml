version: 2
references:
  container_config: &docker-container-config
    docker:
      - image: williamlauze/docker-alpine-utils:latest
    working_directory: ~/docker
jobs:
  tests:
    <<: *docker-container-config
    steps:
      - checkout
      - setup_remote_docker:
          version: 17.07.0-ce
          docker_layer_caching: true
      - run:
          name: tests
          command: |
            npm run docker:build:common
            npm run docker:build:pipeline
            npm run docker:teststep:ci
            npm run docker:codestyle
  docker-deploy-image:
    <<: *docker-container-config
    steps:
      - checkout
      - setup_remote_docker:
          version: 17.07.0-ce
          docker_layer_caching: true
      - run:
          name: docker-deploy-image
          command: |
            VERSION=$(cat package.json | jq -r .version)
            if sh /scripts/list-public-docker-tags.sh williamlauze/harvest-balance-calculator | grep ${VERSION}; then
              echo "Version number already used"
              echo "Did you forget to increase package.json version number?"
            else
              docker login -u ${DOCKERHUB_USER} -p ${DOCKERHUB_PASSWORD}
              npm run docker:build:common
              npm run deploy
            fi
workflows:
  version: 2
  test-and-deploy-docker-image:
    jobs:
      - tests
      - docker-deploy-image:
          requires:
            - tests
          filters:
            branches:
              only: master